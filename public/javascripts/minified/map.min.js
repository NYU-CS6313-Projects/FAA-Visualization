var mapViewModule=function(){"use strict";var a,b={};return b.create=function(b,c,d,e){function f(a){if(d3.select("#weather-breakdown").remove(),console.log(a.properties.code),k.node()===this)return g();k.classed("active",!1),k=d3.select(this).classed("active",!0);var b=m.bounds(a),c=b[1][0]-b[0][0],d=b[1][1]-b[0][1],e=(b[0][0]+b[1][0])/2,f=(b[0][1]+b[1][1])/2,l=.9/Math.max(c/i,d/j),n=[i/2-l*e,j/2-l*f];q.transition().duration(750).style("stroke-width",1.5/l+"px").attr("transform","translate("+n+")scale("+l+")"),h(a.properties.code)}function g(){k.classed("active",!1),k=d3.select(null),q.transition().duration(750).style("stroke-width","1.5px").attr("transform","translate(100,100)scale(0.6, 0.6)")}function h(b){function c(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y"),i=parseFloat(c.attr("dy")),j=c.text(null).append("tspan").attr("x",0).attr("y",h).attr("dy",i+"em");a=d.pop();)e.push(a),j.text(e.join(" ")),j.node().getComputedTextLength()>b&&(e.pop(),j.text(e.join(" ")),e=[a],j=c.append("tspan").attr("x",0).attr("y",h).attr("dy",++f*g+i+"em").text(a))})}function d(a){d3.selectAll("g .bar").filter(function(b){return b!==a}).style("opacity",.2)}function e(){d3.selectAll("g .bar").style("opacity",1)}var f=d3.nest().key(function(a){return a.state}).sortKeys(d3.ascending).key(function(a){return a.weather}).rollup(function(a){return a.length}).entries(a).filter(function(a){return b==a.key});console.log(f[0].values),f[0].values=f[0].values.sort(function(a,b){return b.values-a.values}).filter(function(a,b){return"null"!=a.key&&"Other"!=a.key&&"Unknown"!=a.key&&(0==b||1==b||2==b||3==b||4==b||5==b||6==b||7==b)});var g={top:20,right:20,bottom:30,left:40},h=475-g.left-g.right,i=510-g.top-g.bottom,j=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return"<strong>Frequency:</strong> <span style='color:red'>"+a.values+"</span>"}),k=d3.scale.ordinal().rangeRoundBands([0,h],.1,1),l=d3.scale.linear().range([i,0]),m=d3.svg.axis().scale(k).orient("bottom"),o=d3.svg.axis().scale(l).orient("left").tickFormat(d3.format(".2s")),p=n.append("g").attr("id","weather-breakdown").attr("transform","translate("+g.left+","+g.top+")");n.call(j);var q=d3.scale.ordinal().range(["#B2182B","#E08214","#676767","#EF8A62","#D8B365","#999999"]);f[0].values.forEach(function(a){a.values=+a.values}),k.domain(f[0].values.map(function(a){return a.key})),l.domain([0,d3.max(f[0].values,function(a){return a.values})]),p.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(m).selectAll(".tick text").call(c,k.rangeBand()),p.append("g").attr("class","y axis").call(o).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Frequency"),p.selectAll(".bar").data(f[0].values).enter().append("rect").attr("class","bar").attr("x",function(a){return k(a.key)}).attr("width",k.rangeBand()).attr("y",function(a){return l(a.values)}).attr("height",function(a){return i-l(a.values)}).style("fill",function(a){return q(a.key)}).on("mouseover",function(a){j.show(a),d(a)}).on("mouseout",function(a){j.hide(a),e(a)}),console.log(f)}var i=475,j=510,k=d3.select(null),l=d3.geo.albersUsa().scale(1e3).translate([i/2,j/2]),m=d3.geo.path().projection(l),n=d3.select("#side-view").append("svg").attr("class",c+"-mapview").attr("width",i).attr("height",j);n.append("rect").attr("class","background").attr("width",i).attr("height",j).on("click",g);{var o,p,q=n.append("g").style("stroke-width","1.5px").attr("transform","translate(100,100)scale(0.6, 0.6)");d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return"<strong>Frequency:</strong> <span style='color:red'>"+a.frequency+"</span>"})}d3.csv(csv_path,function(b,g){d3.json("/javascripts/us-named.json",function(b,h){void 0!=d&&void 0!=e&&(g=g.filter(function(a){var b=Date.parse(a.date);return b>=d&&e>=b?a:void 0})),a=g,console.log(g);var i=d3.nest().key(function(a){return a.state}).rollup(function(a){return a.length}).map(g),j=d3.nest().key(function(a){return a.state}).rollup(function(a){return fatality_sum=d3.sum(a,function(a,b){return fatalities=null!==a.fatalities?parseInt(a.fatalities):0,fatalities}),fatality_sum}).map(g),k=topojson.feature(h,h.objects.states).features;if(top.location.hash.split("").slice(1,k.length).forEach(function(a,b){(a=+a)>=0&&10>a&&assign(k[b],a?a-1:null)}),"fatalities"==c){var l=Object.keys(j).map(function(a){return j[a]}),n=Math.max.apply(null,l);o=d3.scale.threshold().domain([0,.15*n,.3*n,.45*n,.65*n,.85*n]).range(["#ffffff","#FEE0D2","#FC9272","#FB6A4A","#CB181D","#A50F15","#67000D"]);var r=q.selectAll("path").data(topojson.feature(h,h.objects.states).features).enter().append("path").attr("d",m).attr("class",function(a){return"feature"}).style("fill",function(a){return o(j[a.properties.code])}).on("click",f);r.append("title").text(function(a){return"Fatalities: "+j[a.properties.code]})}if("accidents"==c){var s=Object.keys(i).map(function(a){return i[a]}),t=Math.max.apply(null,s);p=d3.scale.threshold().domain([0,.15*t,.3*t,.45*t,.65*t,.85*t]).range(["#ffffff","#FEE0D2","#FC9272","#FB6A4A","#CB181D","#A50F15","#67000D"]);var r=q.selectAll("path").data(topojson.feature(h,h.objects.states).features).enter().append("path").attr("d",m).attr("class",function(a){return"feature"}).style("fill",function(a){return p(i[a.properties.code])}).on("click",f);r.append("title").text(function(a){return"Accidents: "+i[a.properties.code]})}console.log("states"),console.log(j),console.log(i),q.append("path").datum(topojson.mesh(h,h.objects.states,function(a,b){return a!==b})).attr("class","mesh").attr("d",m)})})},b.update=function(){},b}();