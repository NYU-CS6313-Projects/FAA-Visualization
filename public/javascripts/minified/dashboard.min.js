var barChartModule=barChartModule||{},mapViewModule=mapViewModule||{},collapsibleTreeModule=collapsibleTreeModule||{};data_range=data_range.split(","),function(a){function b(a){var b=new Date(a.getFullYear(),a.getMonth()+1,0),c=+t(a),d=+u(a),e=+t(b),f=+u(b);return"M"+(d+1)*r+","+c*r+"H"+d*r+"V"+7*r+"H"+f*r+"V"+(e+1)*r+"H"+(f+1)*r+"V0H"+(d+1)*r+"Z"}function c(){d3.select(".cd-panel-content svg").remove(),d3.select("#side-view").select("svg").remove(),d3.select("#side-view").insert("div",":first-child").classed("preloader-wrapper",!0).classed("big",!0).classed("active",!0).style("position","relative").style("left","45%").style("margin-top","180px").append("div").classed("spinner-layer",!0).classed("spinner-blue-only",!0).style("border-color","#A00F00").append("div").classed("circle-clipper",!0).classed("left",!0).append("div").classed("circle",!0).style("border-width","10px")}function d(){return G.empty()?(n=void 0,o=void 0,d3.selectAll(".day").style("opacity",1)):(n=G.extent()[0],o=G.extent()[1],d3.selectAll(".day").filter(function(a){var b=Date.parse(a);return b>=n&&o>=b?d3.select(this).style("opacity",1):d3.select(this).style("opacity",.1)}),void 0)}function e(){d3.select("#side-view div.preloader-wrapper.active").remove(),G.empty()?$("#bargraph-view").is(":checked")?barChartModule.create(n,o):($("#accidents").is(":checked")&&mapViewModule.create(h,"accidents",n,o),$("#fatalities").is(":checked")&&mapViewModule.create(h,"fatalities",n,o)):(n=G.extent()[0],o=G.extent()[1],$("#bargraph-view").is(":checked")&&barChartModule.create(n,o),$("#mapview-view").is(":checked")&&($("#accidents").is(":checked")&&mapViewModule.create(h,"accidents",n,o),$("#fatalities").is(":checked")&&mapViewModule.create(h,"fatalities",n,o)),collapsibleTreeModule.create(h.filter(function(a){var b=Date.parse(a.date);return b>=n&&o>=b?a:void 0})))}barChartModule.create(n,o);var f,g,h,i=37,j=44,k={},l=[],m=[],n=void 0,o=void 0,p=750,q=100,r=13,t=d3.time.format("%w"),u=d3.time.format("%U"),v=d3.time.format("%Y-%m-%d"),w=d3.time.format("%Y-%m-%d").parse,x=d3.scale.quantile().domain([1,i]).range(d3.range(1,8).map(function(a){return"q-color"+a+"-10"})),y=d3.scale.quantile().domain([1,j]).range(d3.range(1,8).map(function(a){return"q-color"+a+"-10"})),z=d3.select("#heatmap-panel").selectAll("svg").data(d3.range(parseInt(data_range[0]),parseInt(data_range[1])+1)).enter().append("svg").attr("width",p).attr("height",q).attr("class","RdYlGn").append("g").attr("transform","translate("+(p-53*r)/2+","+(q-7*r-1)+")");z.append("text").attr("transform","translate(-6,"+3.5*r+")rotate(-90)").style("text-anchor","middle").text(function(a){return a});var A=d3.time.scale().range([0,1200]),B=d3.time.scale().range([0,1200]),C=d3.scale.linear().range([50,0]),D=d3.scale.linear().range([50,0]),E=(d3.svg.axis().scale(A).orient("bottom"),d3.svg.axis().scale(B).orient("bottom")),F=(d3.svg.axis().scale(C).orient("left"),d3.svg.area().interpolate("monotone").x(function(a){return B(a.date)}).y0(50).y1(function(a){return D(a.count)})),G=d3.svg.brush().x(B).on("brushstart",c).on("brush",d).on("brushend",e),H=d3.select("#context-slider").append("svg").style("width",1280).style("height",70).style("margin-left",30).append("g").attr("class","context").attr("transform","translate(0,0)"),I=z.selectAll(".day").data(function(a){return d3.time.days(new Date(a,0,1),new Date(a+1,0,1))}).enter().append("rect").attr("class","day").attr("width",r).attr("height",r).attr("x",function(a){return u(a)*r}).attr("y",function(a){return t(a)*r}).datum(v);I.append("title").text(function(a){return a}),z.selectAll(".month").data(function(a){return d3.time.months(new Date(a,0,1),new Date(a+1,0,1))}).enter().append("path").attr("class","month").attr("d",b),d3.csv(csv_path,function(a,b){function c(a,b){return w(a.date)-w(b.date)}h=b,h.forEach(function(a){a.date in k?k[a.date].push(a):k[a.date]=[]}),h.sort(c),g=d3.nest().key(function(a){return a.date}).rollup(function(a){var b={date:null,count:null};return b.date=w(a[0].date),fatality_sum=d3.sum(a,function(a,b){return fatalities=null!==a.fatalities?parseInt(a.fatalities):0,fatalities}),b.count=fatality_sum,l.push(b),fatality_sum}).map(h),f=d3.nest().key(function(a){return a.date}).rollup(function(a){var b={date:null,count:null};return b.date=w(a[0].date),b.count=a.length,m.push(b),b.count}).map(h),weather_data=d3.nest().key(function(a){return a.weather}).rollup(function(a){return a.length}).map(h),category_data=d3.nest().key(function(a){return a.primary_cause}).rollup(function(a){return a.length}).map(h),A.domain(d3.extent(m.map(function(a){return a.date}))),C.domain([0,d3.max(m.map(function(a){return a.count}))]),B.domain(A.domain()),D.domain(C.domain()),I.filter(function(a){return a in f}).attr("class",function(a){return 0===f[a]?"month-"+a.substring(5,7)+" day q-color0-10":"month-"+a.substring(5,7)+" day "+y(f[a])}).select("title").text(function(a){return 0==f[a]?a+": No fatalities!":1==f[a]?a+": "+f[a]+" accident":a+": "+f[a]+" accidents"}),H.append("path").datum(m).attr("class","area").attr("transform","translate(0,0)").attr("d",F),H.append("g").attr("class","x axis").attr("transform","translate(0,50)").call(E),H.append("g").attr("class","x brush").call(G).selectAll("rect").attr("y",-6).attr("height",56),d3.selectAll("g.context g.tick text").attr("transform","translate(9,0)"),collapsibleTreeModule.create(h)}),d3.select(self.frameElement).style("height","2910px");var J=function(){function a(a,b){var c;switch(a){case"#fatalities":c=g,color=x;break;case"#accidents":c=f,color=y}b(c,color)}function b(a,b,c){I.filter(function(b){return b in a}).attr("class",function(c){return 0===a[c]?"month-"+c.substring(5,7)+" day q-color0-10":"month-"+c.substring(5,7)+" day "+b(a[c])}).select("title").text(function(b){switch(c){case"#fatalities":return 0==a[b]?b+": No fatalities!":1==a[b]?b+": "+a[b]+" fatality":b+": "+a[b]+" fatalities";case"#accidents":return 0==a[b]?b+": No accidents!":1==a[b]?b+": "+a[b]+" accident":b+": "+a[b]+" accidents"}})}d3.selectAll("#accidents, #fatalities").on("click",function(){$("#accidents").is(":checked")&&(a("#accidents",function(a,c){b(a,c,"#accidents"),A.domain(d3.extent(m.map(function(a){return a.date}))),C.domain([0,d3.max(m.map(function(a){return a.count}))]),B.domain(A.domain()),D.domain(C.domain()),H=d3.selectAll("g.context path.area").datum(m).transition().duration(1e3).attr("d",F)}),"fatalities-mapview"==d3.select("#side-view").select("svg").attr("class")&&(d3.select("#side-view").select("svg").remove(),mapViewModule.create(h,"accidents",n,o))),$("#fatalities").is(":checked")&&(a("#fatalities",function(a,c){b(a,c,"#fatalities"),A.domain(d3.extent(l.map(function(a){return a.date}))),C.domain([0,d3.max(l.map(function(a){return a.count}))]),B.domain(A.domain()),D.domain(C.domain()),H=d3.selectAll("g.context path.area").datum(l).transition().duration(1e3).attr("d",F)}),"accidents-mapview"==d3.select("#side-view").select("svg").attr("class")&&(d3.select("#side-view").select("svg").remove(),mapViewModule.create(h,"fatalities",n,o)))})};J(),d3.selectAll(".day").on("click",function(a){date=Date.parse(a),n=date,o=date,d3.selectAll(".day").style("opacity",function(b){return b==a?1:.1}),s=JSON.stringify(k[a]),d3.select(".cd-panel-content svg").remove(),collapsibleTreeModule.create(k[a]),$("#bargraph-view").is(":checked")&&(d3.select("#side-view").select("svg").remove(),d3.selectAll("#dropdown3 li").remove(),barChartModule.create(n,o)),$("#mapview-view").is(":checked")&&(d3.select("#side-view").select("svg").remove(),$("#fatalities").is(":checked")&&mapViewModule.create(h,"fatalities",n,o),$("#accidents").is(":checked")&&mapViewModule.create(h,"accidents",n,o))}),d3.selectAll("#bargraph-view, #mapview-view").on("click",function(){$("#bargraph-view").is(":checked")&&(d3.select("#side-view").select("svg").remove(),d3.selectAll("#dropdown3 li").remove(),barChartModule.create(n,o)),$("#mapview-view").is(":checked")&&(d3.select("#side-view").select("svg").remove(),$("#fatalities").is(":checked")&&mapViewModule.create(h,"fatalities",n,o),$("#accidents").is(":checked")&&mapViewModule.create(h,"accidents",n,o))}),$("#weekday-dropdown.btn.dropdown-button").click(function(){$("ul#dropdown1").show(),$("ul#dropdown1").css({opacity:1})}),$("#month-dropdown.btn.dropdown-button").click(function(){$("ul#dropdown2").show(),$("ul#dropdown2").css({opacity:1})}),$("#accident-type-dropdown.btn.dropdown-button").click(function(){$("ul#dropdown3").show(),$("ul#dropdown3").css({opacity:1})}),$("ul#dropdown1 li a").click(function(a){$("#weekday-dropdown.btn.dropdown-button span").text($(this).text()),$("ul#dropdown1").hide(),$("ul#dropdown1").css({opacity:0})}),$("ul#dropdown2 li a").click(function(a){$("#month-dropdown.btn.dropdown-button span").text($(this).text()),$("ul#dropdown2").hide(),$("ul#dropdown2").css({opacity:0})}),$(document).mouseup(function(a){var b=$("#dropdown1");b.is(a.target)||0!==b.has(a.target).length||b.hide()}),$(document).mouseup(function(a){var b=$("#dropdown2");b.is(a.target)||0!==b.has(a.target).length||b.hide()}),$("ul#dropdown1 li").click(function(){switch($(this).text()){case"Weekday":d3.selectAll("rect.day").style("opacity",1);break;case"Sunday":d3.selectAll("rect.day").style("opacity",function(a){return 0==d3.select(this).attr("y")?1:.1});break;case"Monday":d3.selectAll("rect.day").style("opacity",function(a){return 13==d3.select(this).attr("y")?1:.1});break;case"Tuesday":d3.selectAll("rect.day").style("opacity",function(a){return 26==d3.select(this).attr("y")?1:.1});break;case"Wednesday":d3.selectAll("rect.day").style("opacity",function(a){return 39==d3.select(this).attr("y")?1:.1});break;case"Thursday":d3.selectAll("rect.day").style("opacity",function(a){return 52==d3.select(this).attr("y")?1:.1});break;case"Friday":d3.selectAll("rect.day").style("opacity",function(a){return 65==d3.select(this).attr("y")?1:.1});break;case"Saturday":d3.selectAll("rect.day").style("opacity",function(a){return 78==d3.select(this).attr("y")?1:.1})}}),$("ul#dropdown2 li").click(function(){switch($(this).text()){case"Month":d3.selectAll("rect.day").style("opacity",1);break;case"January":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-01")?1:.1});break;case"February":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-02")?1:.1});break;case"March":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-03")?1:.1});break;case"April":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-04")?1:.1});break;case"May":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-05")?1:.1});break;case"June":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-06")?1:.1});break;case"July":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-07")?1:.1});break;case"August":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-08")?1:.1});break;case"September":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-09")?1:.1});break;case"October":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-10")?1:.1});break;case"November":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-11")?1:.1});break;case"December":d3.selectAll("rect.day").style("opacity",function(a){return d3.select(this).classed("month-12")?1:.1})}})}(this);